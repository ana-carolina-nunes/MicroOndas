@page "/microondas"
@using MicroOndas.Application.Interfaces
@using MicroOndas.Application.Models
@inject IMicroOndasService MicroOndasService

<h3>Micro-ondas Digital</h3>

@if (!string.IsNullOrEmpty(MensagemErro))
{
    <div style="color:darkred; margin-bottom:10px;">@MensagemErro</div>
}

<div style="max-width:900px;">
    <div style="margin-bottom:8px;">
        <label><strong>Programa de Aquecimento</strong></label>
        <select @onchange="OnProgramaChange" style="width:100%; padding:6px;">
            <option value="">-- selecione (ou deixe em branco para manual) --</option>
            @foreach (var p in Programas)
            {
                <option value="@p.Nome" selected="@(ProgramaSelecionado?.Nome == p.Nome)">
                    @p.Nome - @p.Alimento @if (p.IsCustom)
                    {<em>(custom)</em>}
                </option>
            }
        </select>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:12px;">
        <div style="flex:1;">
            <label>Tempo (segundos)</label><br />
            <input type="number" @bind="TempoInput" min="1" max="99999" disabled="@ModoPrograma" style="width:100%; padding:6px;" />
        </div>
        <div style="width:160px;">
            <label>Potência (1-10)</label><br />
            <input type="number" @bind="PotenciaInput" min="1" max="10" disabled="@ModoPrograma" style="width:100%; padding:6px;" />
        </div>
        <div style="width:120px;">
            <label>Caractere</label><br />
            <input type="text" @bind="CaractereInput" maxlength="1" disabled="@ModoPrograma" style="width:100%; padding:6px;" />
        </div>
    </div>

    <div style="margin-bottom:12px;">
        <button @onclick="Iniciar" style="padding:10px; background:#007bff; color:white; border:none; cursor:pointer;">Iniciar</button>
        <button @onclick="PausarOuCancelar" style="padding:10px; margin-left:8px; background:#6c757d; color:white; border:none; cursor:pointer;">Pausar / Cancelar</button>
        <button @onclick="IniciarRapido" style="padding:10px; margin-left:8px; background:#28a745; color:white; border:none; cursor:pointer;">Início Rápido</button>
    </div>

    <div style="margin-top:18px; border:1px solid #ddd; padding:12px; border-radius:4px;">
        <div style="margin-bottom:8px;"><strong>Display:</strong> @MicroOndasService.ObterDisplay()</div>
        <div style="margin-bottom:8px; white-space:pre-wrap;">@MicroOndasService.ObterProcessoVisual()</div>

        @if (!string.IsNullOrEmpty(MensagemFinal))
        {
            <div style="margin-top:12px; font-weight:bold; color:green;">@MensagemFinal</div>
        }
    </div>

    <hr />

    <h4>Cadastro de Programa Customizado</h4>
    <div style="background:#f8f9fa; padding:12px; border-radius:4px; max-width:720px;">
        <div style="margin-bottom:8px;">
            <label>Nome * </label><br />
            <input @bind="NovoNome" style="width:100%; padding:6px;" maxlength="60" />
        </div>
        <div style="margin-bottom:8px;">
            <label>Alimento * </label><br />
            <input @bind="NovoAlimento" style="width:100%; padding:6px;" maxlength="60" />
        </div>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <div style="flex:1;">
                <label>Tempo (segundos) * </label><br />
                <input type="number" @bind="NovoTempo" min="1" style="width:100%; padding:6px;" />
            </div>
            <div style="width:140px;">
                <label>Potência (1-10) * </label><br />
                <input type="number" @bind="NovoPotencia" min="1" max="10" style="width:100%; padding:6px;" />
            </div>
            <div style="width:120px;">
                <label>Caractere * </label><br />
                <input type="text" @bind="NovoCaractere" maxlength="1" style="width:100%; padding:6px;" />
            </div>
        </div>
        <div style="margin-bottom:8px;">
            <label>Instruções (opcional)</label><br />
            <textarea @bind="NovaInstrucao" rows="3" style="width:100%; padding:6px;"></textarea>
        </div>
        <div>
            <button @onclick="CriarPrograma" style="padding:8px 12px; background:#17a2b8; color:white; border:none; cursor:pointer;">Salvar programa</button>
            <span style="margin-left:12px; color:#666;">(caractere não pode ser "." nem repetir com outro programa)</span>
        </div>
    </div>
</div>

@code {
    // inputs execução
    private int TempoInput { get; set; } = 0;
    private int PotenciaInput { get; set; } = 10;
    private string CaractereInput { get; set; } = ".";

    // cadastro custom
    private string NovoNome { get; set; } = "";
    private string NovoAlimento { get; set; } = "";
    private int NovoTempo { get; set; } = 30;
    private int NovoPotencia { get; set; } = 5;
    private string NovoCaractere { get; set; } = "*";
    private string NovaInstrucao { get; set; } = "";

    private IReadOnlyList<ProgramaAquecimento> Programas => MicroOndasService.ObterTodosProgramas();
    private ProgramaAquecimento? ProgramaSelecionado;
    private string MensagemErro = "";
    private string MensagemFinal = "";

    private bool ModoPrograma => ProgramaSelecionado is not null;
    private string CaractereExibicao => ProgramaSelecionado?.CaractereAquecimento ?? ".";

    protected override void OnInitialized()
    {
        MicroOndasService.OnTick += () => InvokeAsync(StateHasChanged);
        MicroOndasService.OnFinished += () =>
        {
            MensagemFinal = "Aquecimento concluído!";
            ProgramaSelecionado = null;
            InvokeAsync(StateHasChanged);
        };
    }

    private void OnProgramaChange(ChangeEventArgs e)
    {
        MensagemErro = string.Empty;
        MensagemFinal = string.Empty;

        var nome = Convert.ToString(e.Value) ?? string.Empty;
        if (string.IsNullOrWhiteSpace(nome))
        {
            ProgramaSelecionado = null;
            return;
        }

        ProgramaSelecionado = Programas.FirstOrDefault(p => p.Nome == nome);
        if (ProgramaSelecionado != null)
        {
            TempoInput = ProgramaSelecionado.TempoSegundos;
            PotenciaInput = ProgramaSelecionado.Potencia;
            CaractereInput = ProgramaSelecionado.CaractereAquecimento;
        }
    }

    private void Iniciar()
    {
        MensagemErro = "";
        MensagemFinal = "";

        try
        {
            if (ProgramaSelecionado is not null)
            {
                MicroOndasService.IniciarAquecimento(ProgramaSelecionado);
            }
            else
            {
                if (TempoInput <= 0) { MensagemErro = "Informe um tempo válido."; return; }
                MicroOndasService.IniciarAquecimento(TempoInput, PotenciaInput);
            }
        }
        catch (Exception ex)
        {
            MensagemErro = ex.Message;
        }
    }

    private void IniciarRapido()
    {
        MensagemErro = ""; MensagemFinal = "";
        TempoInput = 30; PotenciaInput = 10;
        try { MicroOndasService.IniciarAquecimento(TempoInput, PotenciaInput); }
        catch (Exception ex) { MensagemErro = ex.Message; }
    }

    private void PausarOuCancelar()
    {
        if (MicroOndasService.EmExecucao && !MicroOndasService.Pausado) { MicroOndasService.Pausar(); return; }
        if (MicroOndasService.EmExecucao && MicroOndasService.Pausado)
        {
            MicroOndasService.Cancelar();
            TempoInput = 0; PotenciaInput = 10; ProgramaSelecionado = null; MensagemFinal = ""; MensagemErro = ""; return;
        }
        MicroOndasService.Cancelar();
        TempoInput = 0; PotenciaInput = 10; ProgramaSelecionado = null; MensagemFinal = ""; MensagemErro = "";
    }

    private void CriarPrograma()
    {
        MensagemErro = ""; MensagemFinal = "";

        try
        {
            // montar programa (IsCustom tratado pelo service)
            var p = new ProgramaAquecimento(NovoNome?.Trim() ?? "",
                                           NovoAlimento?.Trim() ?? "",
                                           NovoTempo,
                                           NovoPotencia,
                                           NovoCaractere?.Trim() ?? "",
                                           NovaInstrucao ?? "",
                                           true);

            MicroOndasService.AdicionarProgramaCustomizado(p);

            // limpar campos de cadastro (opcional)
            NovoNome = "";
            NovoAlimento = "";
            NovoTempo = 30;
            NovoPotencia = 5;
            NovoCaractere = "*";
            NovaInstrucao = "";

            // atualizar UI
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            MensagemErro = ex.Message;
        }
    }
}
