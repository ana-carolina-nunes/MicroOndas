@page "/microondas"
@using MicroOndas.Application.Interfaces
@using MicroOndas.Application.Models
@inject IMicroOndasService MicroOndasService

<h3>Micro-ondas Digital</h3>

@if (MensagemErro is not null)
{
<p style="color:red">@MensagemErro</p>
}

<div>
    <label>Tempo (segundos): </label>
    <input type="number" @bind="TempoInput" @(ModoPrograma ? "disabled" : "" ) />
</div>

<div>
    <label>Potência (1 a 10): </label>
    <input type="number" @bind="PotenciaInput" @(ModoPrograma ? "disabled" : "" ) />
</div>

<div style="margin-top:10px;">
    <button @onclick="Iniciar">Iniciar</button>
    <button @onclick="PausarOuCancelar">Pausar / Cancelar</button>
    <button @onclick="IniciarRapido">Início Rápido</button>
</div>

<hr />

<h4>Programas Pré-definidos</h4>

@foreach (var prog in Programas)
{
<button @onclick="() => SelecionarPrograma(prog)">
    @prog.Nome (@prog.TempoFormatado, Potência @prog.Potencia)
</button>
}

@if (ProgramaSelecionado is not null)
{
<p><b>Alimento:</b> @ProgramaSelecionado.Alimento</p>
<p><b>Instruções:</b> @ProgramaSelecionado.Instrucoes</p>
<p><b>Caractere de aquecimento:</b> "@ProgramaSelecionado.CaractereAquecimento"</p>
}

<hr />

<h3>Status</h3>

<p>@Display</p>

@if (MensagemFinal is not null)
{
<p style="font-weight:bold; color:green">@MensagemFinal</p>
}

@code {

    private int TempoInput;
    private int PotenciaInput = 10;
    private string? MensagemErro;
    private string? MensagemFinal;

    private bool ModoPrograma => ProgramaSelecionado is not null;
    private ProgramaAquecimento? ProgramaSelecionado;

    private IReadOnlyList<ProgramaAquecimento>
    Programas => MicroOndasService.ObterProgramasPreDefinidos();

    private string Display => MicroOndasService.ObterDisplay();

    protected override void OnInitialized()
    {
    MicroOndasService.OnTick += () => InvokeAsync(StateHasChanged);
    MicroOndasService.OnFinished += () =>
    {
    MensagemFinal = "Aquecimento concluído";
    ProgramaSelecionado = null;
    InvokeAsync(StateHasChanged);
    };
    }

    private void Iniciar()
    {
    MensagemErro = null;
    MensagemFinal = null;

    try
    {
    if (ModoPrograma)
    MicroOndasService.IniciarAquecimento(ProgramaSelecionado!);
    else
    MicroOndasService.IniciarAquecimento(TempoInput, PotenciaInput);
    }
    catch (Exception ex)
    {
    MensagemErro = ex.Message;
    }
    }

    private void IniciarRapido()
    {
    MensagemErro = null;
    MensagemFinal = null;
    TempoInput = 30;
    PotenciaInput = 10;

    try
    {
    MicroOndasService.IniciarAquecimento(TempoInput, PotenciaInput);
    }
    catch (Exception ex)
    {
    MensagemErro = ex.Message;
    }
    }

    private void PausarOuCancelar()
    {
    if (MicroOndasService.EmExecucao)
    {
    MicroOndasService.Pausar();
    }
    else if (ProgramaSelecionado is not null || TempoInput > 0)
    {
    MicroOndasService.Cancelar();
    TempoInput = 0;
    PotenciaInput = 10;
    ProgramaSelecionado = null;
    MensagemFinal = null;
    }
    }

    private void SelecionarPrograma(ProgramaAquecimento programa)
    {
    ProgramaSelecionado = programa;
    TempoInput = programa.TempoSegundos;
    PotenciaInput = programa.Potencia;
    MensagemErro = null;
    MensagemFinal = null;
    }
    }
